<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MQTT - Monitoramento em Tempo Real</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .mqtt-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            .status-item#brokerItem {
                grid-column: span 1;
            }
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .status-item label {
            display: block;
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .status-item .value {
            font-size: 1.5em;
            font-weight: bold;
            word-break: break-all;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .status-item#brokerItem .value {
            font-size: 1.2em;
            line-height: 1.3;
        }
        
        .status-connected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .status-disconnected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .status-simulation {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .alerts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .alerts-list {
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .alert-card {
            background: white;
            border-left: 4px solid;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        
        .alert-card:hover {
            transform: translateX(5px);
        }
        
        .alert-card.cr√≠tica {
            border-left-color: #ef4444;
        }
        
        .alert-card.alta {
            border-left-color: #f59e0b;
        }
        
        .alert-card.m√©dia {
            border-left-color: #3b82f6;
        }
        
        .alert-card.baixa {
            border-left-color: #10b981;
        }
        
        .alert-card.comunica√ß√£o {
            border-left-color: #8b5cf6;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .alert-type {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85em;
        }
        
        .alert-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .alert-severity.cr√≠tica {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .alert-severity.alta {
            background: #fef3c7;
            color: #92400e;
        }
        
        .alert-severity.m√©dia {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .alert-severity.baixa {
            background: #d1fae5;
            color: #065f46;
        }
        
        .alert-message {
            margin: 10px 0;
            color: #374151;
        }
        
        .alert-data {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.85em;
            color: #6b7280;
        }
        
        .alert-data-item {
            margin: 5px 0;
        }
        
        .alert-timestamp {
            font-size: 0.75em;
            color: #9ca3af;
            margin-top: 5px;
        }
        
        .stats-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
        }
        
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #6b7280;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: #4b5563;
        }
        
        @media (max-width: 768px) {
            .alerts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="mqtt-dashboard">
        <a href="index.html" class="back-btn">‚Üê Voltar para Interface Principal</a>
        
        <header>
            <h1>üì° Dashboard MQTT - Monitoramento em Tempo Real</h1>
            <p class="subtitle">Sistema de Alertas e Monitoramento do Data Center</p>
        </header>
        
        <!-- Status MQTT -->
        <section class="status-card" id="statusCard">
            <h2>üîå Status da Conex√£o MQTT</h2>
            <div class="status-grid">
                <div class="status-item">
                    <label>Status</label>
                    <div class="value" id="connectionStatus">Verificando...</div>
                </div>
                <div class="status-item" id="brokerItem" style="grid-column: span 2;">
                    <label>Broker</label>
                    <div class="value" id="brokerInfo">--</div>
                </div>
                <div class="status-item">
                    <label>Protocolo</label>
                    <div class="value" id="protocolInfo">--</div>
                </div>
                <div class="status-item">
                    <label>Modo</label>
                    <div class="value" id="modeInfo">--</div>
                </div>
                <div class="status-item">
                    <label>Falhas de Conex√£o</label>
                    <div class="value" id="failuresCount">--</div>
                </div>
                <div class="status-item">
                    <label>√öltima Tentativa</label>
                    <div class="value" id="lastAttempt" style="font-size: 0.9em;">--</div>
                </div>
            </div>
        </section>
        
        <!-- Estat√≠sticas -->
        <section class="stats-panel">
            <h2>üìä Estat√≠sticas de Alertas</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalAlerts">0</div>
                    <div class="stat-label">Total de Alertas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="criticalAlerts">0</div>
                    <div class="stat-label">Cr√≠ticos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="highAlerts">0</div>
                    <div class="stat-label">Alta Severidade</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="mediumAlerts">0</div>
                    <div class="stat-label">M√©dia Severidade</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lowAlerts">0</div>
                    <div class="stat-label">Baixa Severidade</div>
                </div>
            </div>
        </section>
        
        <!-- Alertas -->
        <section class="alerts-container">
            <div class="card">
                <h2>üö® Alertas Recentes</h2>
                <div id="alertsList" class="alerts-list">
                    <p class="empty-message">Carregando alertas...</p>
                </div>
            </div>
            
            <div class="card">
                <h2>üìã Tipos de Alertas</h2>
                <div id="alertsByType" class="alerts-list">
                    <p class="empty-message">Carregando estat√≠sticas...</p>
                </div>
            </div>
        </section>
        
        <button class="refresh-btn" onclick="loadDashboard()">üîÑ Atualizar</button>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // Carrega dashboard ao iniciar
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            // Atualiza a cada 5 segundos
            setInterval(loadDashboard, 5000);
        });
        
        async function loadDashboard() {
            try {
                await Promise.all([
                    loadMQTTStatus(),
                    loadAlerts()
                ]);
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }
        
        async function loadMQTTStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/mqtt/status`);
                const status = await response.json();
                
                // Atualiza status card
                const statusCard = document.getElementById('statusCard');
                if (status.connected) {
                    statusCard.className = 'status-card status-connected';
                    document.getElementById('connectionStatus').textContent = 'Conectado';
                } else if (status.simulation_mode) {
                    statusCard.className = 'status-card status-simulation';
                    document.getElementById('connectionStatus').textContent = 'Modo Simula√ß√£o';
                } else {
                    statusCard.className = 'status-card status-disconnected';
                    document.getElementById('connectionStatus').textContent = 'Desconectado';
                }
                
                // Monta URL completa do broker
                let brokerUrl = `${status.broker_host}:${status.broker_port}`;
                if (status.use_websockets && status.broker_path) {
                    brokerUrl += status.broker_path;
                }
                document.getElementById('brokerInfo').textContent = brokerUrl;
                
                // Mostra protocolo usado
                if (status.use_websockets) {
                    document.getElementById('protocolInfo').textContent = 'WebSocket';
                } else {
                    document.getElementById('protocolInfo').textContent = 'TCP';
                }
                
                document.getElementById('modeInfo').textContent = status.simulation_mode ? 'Simula√ß√£o' : 'Normal';
                document.getElementById('failuresCount').textContent = status.connection_failures;
                
                // √öltima tentativa de conex√£o
                if (status.last_connection_attempt) {
                    const lastAttempt = new Date(status.last_connection_attempt);
                    document.getElementById('lastAttempt').textContent = lastAttempt.toLocaleString('pt-BR');
                } else {
                    document.getElementById('lastAttempt').textContent = 'Nunca';
                }
                
            } catch (error) {
                console.error('Erro ao carregar status MQTT:', error);
                document.getElementById('connectionStatus').textContent = 'Erro ao conectar';
            }
        }
        
        async function loadAlerts() {
            try {
                const response = await fetch(`${API_BASE_URL}/mqtt/alerts?limit=100`);
                const data = await response.json();
                const alerts = data.alerts || [];
                
                // Atualiza estat√≠sticas
                updateStatistics(alerts);
                
                // Exibe alertas
                displayAlerts(alerts);
                
                // Exibe estat√≠sticas por tipo
                displayAlertsByType(alerts);
                
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                document.getElementById('alertsList').innerHTML = 
                    '<p class="empty-message">Erro ao carregar alertas</p>';
            }
        }
        
        function updateStatistics(alerts) {
            const total = alerts.length;
            const critical = alerts.filter(a => a.severidade === 'cr√≠tica').length;
            const high = alerts.filter(a => a.severidade === 'alta').length;
            const medium = alerts.filter(a => a.severidade === 'm√©dia').length;
            const low = alerts.filter(a => a.severidade === 'baixa').length;
            
            document.getElementById('totalAlerts').textContent = total;
            document.getElementById('criticalAlerts').textContent = critical;
            document.getElementById('highAlerts').textContent = high;
            document.getElementById('mediumAlerts').textContent = medium;
            document.getElementById('lowAlerts').textContent = low;
        }
        
        function displayAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p class="empty-message">Nenhum alerta ainda</p>';
                return;
            }
            
            // Ordena por timestamp (mais recente primeiro)
            const sortedAlerts = [...alerts].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            alertsList.innerHTML = sortedAlerts.map(alert => {
                const timestamp = new Date(alert.timestamp).toLocaleString('pt-BR');
                const tipoClass = alert.tipo === 'comunica√ß√£o' ? 'comunica√ß√£o' : '';
                
                let dataHtml = '';
                if (alert.dados && Object.keys(alert.dados).length > 0) {
                    dataHtml = '<div class="alert-data">';
                    Object.entries(alert.dados).forEach(([key, value]) => {
                        dataHtml += `<div class="alert-data-item"><strong>${key}:</strong> ${JSON.stringify(value)}</div>`;
                    });
                    dataHtml += '</div>';
                }
                
                return `
                    <div class="alert-card ${alert.severidade} ${tipoClass}">
                        <div class="alert-header">
                            <span class="alert-type">${alert.tipo}</span>
                            <span class="alert-severity ${alert.severidade}">${alert.severidade}</span>
                        </div>
                        <div class="alert-message">${alert.mensagem}</div>
                        ${dataHtml}
                        <div class="alert-timestamp">${timestamp}</div>
                    </div>
                `;
            }).join('');
        }
        
        function displayAlertsByType(alerts) {
            const alertsByType = document.getElementById('alertsByType');
            
            const byType = {};
            alerts.forEach(alert => {
                if (!byType[alert.tipo]) {
                    byType[alert.tipo] = {
                        total: 0,
                        cr√≠tica: 0,
                        alta: 0,
                        m√©dia: 0,
                        baixa: 0
                    };
                }
                byType[alert.tipo].total++;
                if (byType[alert.tipo][alert.severidade] !== undefined) {
                    byType[alert.tipo][alert.severidade]++;
                }
            });
            
            if (Object.keys(byType).length === 0) {
                alertsByType.innerHTML = '<p class="empty-message">Nenhum alerta ainda</p>';
                return;
            }
            
            alertsByType.innerHTML = Object.entries(byType).map(([tipo, stats]) => {
                return `
                    <div class="alert-card">
                        <div class="alert-header">
                            <span class="alert-type">${tipo}</span>
                        </div>
                        <div class="alert-data">
                            <div class="alert-data-item"><strong>Total:</strong> ${stats.total}</div>
                            ${stats.cr√≠tica > 0 ? `<div class="alert-data-item">Cr√≠tica: ${stats.cr√≠tica}</div>` : ''}
                            ${stats.alta > 0 ? `<div class="alert-data-item">Alta: ${stats.alta}</div>` : ''}
                            ${stats.m√©dia > 0 ? `<div class="alert-data-item">M√©dia: ${stats.m√©dia}</div>` : ''}
                            ${stats.baixa > 0 ? `<div class="alert-data-item">Baixa: ${stats.baixa}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>

